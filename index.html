<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Chart Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gantt-grid {
            display: grid;
            position: relative;
            border-left: 1px solid #e5e7eb;
        }
        .day-column {
            border-right: 1px solid #f3f4f6;
            min-width: 40px;
            height: 100%;
            position: relative;
            flex-shrink: 0;
        }
        /* Sticky Column for Task Names */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: white;
            border-right: 2px solid #e5e7eb;
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
        }
        .today-column {
            background-color: rgba(239, 68, 68, 0.1) !important; 
        }
        .today-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ef4444;
            z-index: 15;
            pointer-events: none;
        }
        .task-bar {
            height: 24px;
            border-radius: 4px;
            position: absolute;
            z-index: 10;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75rem;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .progress-overlay {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px 0 0 4px;
        }
        .date-header {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        .editable-input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 2px;
            border-radius: 4px;
        }
        .editable-input:focus {
            background: white;
            outline: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Notification Banner -->
        <div id="notifBanner" class="hidden bg-blue-50 p-4 border-b border-blue-100 flex items-center justify-between">
            <div class="flex items-center text-blue-700 text-sm">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                通知を有効にしますか？（当日・5日前）
            </div>
            <div class="flex space-x-2">
                <button onclick="requestNotifPermission()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">有効にする</button>
                <button onclick="dismissNotifBanner()" class="text-blue-400 text-sm">後で</button>
            </div>
        </div>

        <div class="p-6 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">ガントチャート・ジェネレーター</h1>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">タスク名</label>
                    <input type="text" id="taskName" class="mt-1 block w-full border rounded-md p-2 text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">開始日</label>
                    <input type="date" id="startDate" class="mt-1 block w-full border rounded-md p-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">終了日</label>
                    <input type="date" id="endDate" class="mt-1 block w-full border rounded-md p-2 text-sm">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700">メモ</label>
                    <input type="text" id="taskMemo" class="mt-1 block w-full border rounded-md p-2 text-sm">
                </div>
                <div class="flex items-end">
                    <button onclick="addTask()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md font-bold transition">追加</button>
                </div>
            </div>
        </div>

        <!-- Gantt Chart View -->
        <div class="overflow-x-auto p-6 scroll-smooth" id="ganttViewport">
            <div id="chartWrapper" class="inline-block min-w-full">
                <div id="dateHeader" class="flex date-header mb-2 border-b pb-2"></div>
                <div id="taskContainer" class="relative"></div>
            </div>
        </div>

        <!-- Task Tables -->
        <div class="p-6 bg-white border-t border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">タスク一覧</h2>
            <div class="overflow-x-auto mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs text-gray-500">順序</th>
                            <th class="px-4 py-2 text-left text-xs text-gray-500">タスク名</th>
                            <th class="px-4 py-2 text-left text-xs text-gray-500">期間</th>
                            <th class="px-4 py-2 text-left text-xs text-gray-500">進捗 / メモ</th>
                            <th class="px-4 py-2 text-right text-xs text-gray-500">操作</th>
                        </tr>
                    </thead>
                    <tbody id="taskListBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <div id="completedTasksSection" class="hidden opacity-60">
                <h2 class="text-lg font-semibold text-gray-400 mb-4 border-b pb-2">完了済み</h2>
                <tbody id="completedListBody"></tbody>
                <table class="min-w-full divide-y divide-gray-100">
                     <tbody id="completedListBody" class="bg-white divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let tasks = JSON.parse(localStorage.getItem('gantt_tasks')) || [];
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
        const dayWidth = 40;
        const nameColWidth = 192; // 48 * 4px (w-48)

        function saveToLocalStorage() {
            localStorage.setItem('gantt_tasks', JSON.stringify(tasks));
        }

        function init() {
            checkNotifPermission();
            renderGantt();
            renderTaskList();
            
            const today = new Date();
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            const end = new Date(); end.setDate(today.getDate() + 7);
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            
            checkReminders();
            scrollToToday(); // 今日を中心にスクロール
        }

        function checkNotifPermission() {
            if (!("Notification" in window)) return;
            if (Notification.permission === "default") document.getElementById('notifBanner').classList.remove('hidden');
        }

        function requestNotifPermission() {
            Notification.requestPermission().then(() => document.getElementById('notifBanner').classList.add('hidden'));
        }

        function dismissNotifBanner() {
            document.getElementById('notifBanner').classList.add('hidden');
        }

        function scrollToToday() {
            const viewport = document.getElementById('ganttViewport');
            const todayCol = document.querySelector('.today-column');
            if (todayCol && viewport) {
                // 今日が画面の中央付近に来るように計算
                const offset = todayCol.offsetLeft - (viewport.clientWidth / 2) + (dayWidth / 2);
                viewport.scrollLeft = offset > 0 ? offset : 0;
            }
        }

        function addTask() {
            const name = document.getElementById('taskName').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const memo = document.getElementById('taskMemo').value;
            if (!name || !start || !end) return;

            tasks.push({
                id: Date.now(),
                name, start, end, memo: memo || '',
                progress: 0, color: colors[tasks.length % colors.length],
                completed: false
            });
            saveToLocalStorage();
            renderGantt();
            renderTaskList();
        }

        function getRange() {
            const activeTasks = tasks.filter(t => !t.completed);
            const now = new Date();
            const startDates = activeTasks.map(t => new Date(t.start));
            const endDates = activeTasks.map(t => new Date(t.end));
            const minDate = new Date(Math.min(...startDates, now));
            minDate.setDate(minDate.getDate() - 7);
            const maxDate = new Date(Math.max(...endDates, now));
            maxDate.setDate(maxDate.getDate() + 21);
            return { start: minDate, end: maxDate };
        }

        function renderGantt() {
            const range = getRange();
            const totalDays = Math.ceil((range.end - range.start) / (1000 * 60 * 60 * 24));
            const todayStr = new Date().toISOString().split('T')[0];
            const dateHeader = document.getElementById('dateHeader');
            const taskContainer = document.getElementById('taskContainer');
            
            // Header
            dateHeader.innerHTML = `<div class="w-48 flex-shrink-0 font-bold text-gray-400 text-sm sticky-col p-2">タスク名</div>`;
            taskContainer.innerHTML = '';
            
            for (let i = 0; i < totalDays; i++) {
                const date = new Date(range.start); date.setDate(date.getDate() + i);
                const isToday = date.toISOString().split('T')[0] === todayStr;
                const dayDiv = document.createElement('div');
                dayDiv.className = `day-column text-center text-[10px] text-gray-400 py-1 ${isToday ? 'today-column' : ''}`;
                dayDiv.style.width = `${dayWidth}px`;
                dayDiv.innerHTML = `${date.getMonth() + 1}/${date.getDate()}`;
                if (isToday) dayDiv.innerHTML += '<div class="today-line"></div>';
                dateHeader.appendChild(dayDiv);
            }

            // Tasks
            tasks.filter(t => !t.completed).forEach((task) => {
                const row = document.createElement('div');
                row.className = 'flex items-center mb-3 h-8 relative';
                
                // Sticky Name
                const nameBox = document.createElement('div');
                nameBox.className = 'w-48 flex-shrink-0 text-xs font-medium truncate pr-3 sticky-col p-2';
                nameBox.innerText = task.name;
                row.appendChild(nameBox);

                const grid = document.createElement('div');
                grid.className = 'flex relative h-full flex-grow';
                
                const taskStart = new Date(task.start);
                const offsetDays = Math.ceil((taskStart - range.start) / (1000 * 60 * 60 * 24));
                const durationDays = Math.max(1, Math.ceil((new Date(task.end) - taskStart) / (1000 * 60 * 60 * 24)) + 1);
                
                const bar = document.createElement('div');
                bar.className = 'task-bar';
                bar.style.left = `${offsetDays * dayWidth}px`;
                bar.style.width = `${durationDays * dayWidth}px`;
                bar.style.backgroundColor = task.color;
                bar.innerHTML = `
                    <span class="truncate text-[10px] font-bold z-20 progress-text-${task.id}">${task.progress}%</span>
                    <div class="progress-overlay progress-bar-${task.id}" style="width: ${task.progress}%"></div>
                `;
                
                grid.appendChild(bar); row.appendChild(grid);
                taskContainer.appendChild(row);
            });
        }

        function renderTaskList() {
            const body = document.getElementById('taskListBody');
            body.innerHTML = '';
            const active = tasks.filter(t => !t.completed);
            active.forEach((task, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2 text-xs text-gray-400">
                        <button onclick="moveTask(${index}, -1)" class="${index===0?'invisible':''}">▲</button>
                        <button onclick="moveTask(${index}, 1)" class="${index===active.length-1?'invisible':''}">▼</button>
                    </td>
                    <td class="px-4 py-2 text-sm font-medium">
                        <input type="text" value="${task.name}" onchange="updateTaskField(${task.id}, 'name', this.value)" class="editable-input">
                    </td>
                    <td class="px-4 py-2 text-[10px] text-gray-500">
                        <input type="date" value="${task.start}" onchange="updateTaskField(${task.id}, 'start', this.value)" class="block mb-1">
                        <input type="date" value="${task.end}" onchange="updateTaskField(${task.id}, 'end', this.value)">
                    </td>
                    <td class="px-4 py-2">
                        <div class="flex items-center space-x-2">
                            <input type="range" min="0" max="100" value="${task.progress}" 
                                oninput="updateRangePreview(this, ${task.id})"
                                onchange="updateTaskField(${task.id}, 'progress', parseInt(this.value))"
                                class="w-20">
                            <span class="text-[10px] range-val-${task.id}">${task.progress}%</span>
                        </div>
                        <input type="text" value="${task.memo}" onchange="updateTaskFieldNoRefresh(${task.id}, 'memo', this.value)" placeholder="メモ..." class="text-[10px] w-full border-b mt-1">
                    </td>
                    <td class="px-4 py-2 text-right">
                        <button onclick="toggleComplete(${task.id})" class="text-green-600 font-bold text-xs mr-2">完了</button>
                        <button onclick="deleteTask(${task.id})" class="text-red-400 text-xs">削除</button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        function updateRangePreview(el, id) {
            const val = el.value + '%';
            document.querySelector(`.range-val-${id}`).innerText = val;
            const bar = document.querySelector(`.progress-bar-${id}`);
            const text = document.querySelector(`.progress-text-${id}`);
            if (bar) bar.style.width = val;
            if (text) text.innerText = val;
            updateTaskFieldNoRefresh(id, 'progress', parseInt(el.value));
        }

        function updateTaskField(id, field, value) {
            const task = tasks.find(t => t.id === id);
            if (task) { task[field] = value; saveToLocalStorage(); renderGantt(); }
        }

        function updateTaskFieldNoRefresh(id, field, value) {
            const task = tasks.find(t => t.id === id);
            if (task) { task[field] = value; saveToLocalStorage(); }
        }

        function toggleComplete(id) {
            const task = tasks.find(t => t.id === id);
            if (task) { task.completed = !task.completed; if(task.completed) task.progress=100; saveToLocalStorage(); renderGantt(); renderTaskList(); }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveToLocalStorage(); renderGantt(); renderTaskList();
        }

        function moveTask(idx, dir) {
            const active = tasks.filter(t => !t.completed);
            const t1 = active[idx], t2 = active[idx+dir];
            const i1 = tasks.indexOf(t1), i2 = tasks.indexOf(t2);
            [tasks[i1], tasks[i2]] = [tasks[i2], tasks[i1]];
            saveToLocalStorage(); renderGantt(); renderTaskList();
        }

        function checkReminders() {
            if (Notification.permission !== "granted") return;
            const today = new Date().toISOString().split('T')[0];
            tasks.forEach(t => {
                if (!t.completed && t.end === today) new Notification("締切", { body: `${t.name}は本日が期限です！` });
            });
        }

        window.onload = init;
    </script>
</body>
</html>
